<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mashhad Leather Pricing Platform</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #fff; }
        .topbar { background: #f1f3f4; padding: 10px 20px; border-bottom: 1px solid #dadce0; display: flex; justify-content: space-between; align-items: center; }
        .topbar h1 { margin: 0; font-size: 18px; color: #202124; }
        .topbar .user { color: #5f6368; font-size: 14px; }
        .topbar a { margin-left: 20px; color: #1a73e8; text-decoration: none; }
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .flashed { background: #d2e3fc; color: #185abc; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
        #hot { height: 600px; overflow: hidden; }
        button { padding: 8px 16px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1669c1; }
        input[type="file"] { margin: 10px 0; }
        .ht_master .htCore thead th { font-weight: bold; background: #f1f3f4; }  /* FIX: Bold headers like Google Sheets */
    </style>
</head>
<body>
    <div class="topbar">
        <h1>Mashhad Leather</h1>
        <div class="user">
            {{ current_user.email }} {% if is_admin %}(Admin){% endif %}
            <a href="/logout">Sign out</a>
            {% if is_admin %}<a href="/register">Invite user</a> <a href="/logs">View logs</a>{% endif %}
        </div>
    </div>
    <div class="container">
        {% with messages = get_flashed_messages() %}
            {% if messages %}<div class="flashed">{% for msg in messages %}{{ msg }}<br>{% endfor %}</div>{% endif %}
        {% endwith %}

        <div class="section">
            <h2>Upload Excel File</h2>
            <form method="POST" enctype="multipart/form-data">
                <input type="file" name="upload" accept=".xlsx">
                <button type="submit">Upload</button>
            </form>
        </div>

        {% if is_admin %}
        <div class="section">
            <h2>Admin: Lock Columns</h2>
            <form method="POST">
                <input type="text" name="readonly_columns" placeholder="e.g., A,B" value="{{ ','.join(readonly_columns) }}" style="width: 300px; padding: 8px;">
                <button type="submit">Save Locks</button>
            </form>
        </div>
        {% endif %}

        <div class="section">
            <h2>Spreadsheet</h2>
            <div id="hot"></div>
            <button onclick="saveChanges()" style="margin-top: 10px;">Save Changes</button>
        </div>
    </div>

    <script>
        const data = {{ data | safe }};
        const readonlyColumns = {{ readonly_columns | tojson | safe }}.map(col => col.charCodeAt(0) - 65);

        const container = document.getElementById('hot');
        const hot = new Handsontable(container, {
            data: data,
            rowHeaders: true,
            colHeaders: true,
            height: 'auto',
            width: '100%',
            licenseKey: 'non-commercial-and-evaluation',
            fixedRowsTop: 1,  // FIX: Freeze headers
            filters: true,  // FIX: Enable column filters
            dropdownMenu: true,  // FIX: Dropdown for filters/sorting
            renderer: 'html',  // FIX: Allow HTML (for images)
            cells: function(row, col) {
                const cellProperties = {};
                if (row === 0 || readonlyColumns.includes(col)) {
                    cellProperties.readOnly = true;
                    cellProperties.className = 'htReadOnly';  // Gray out read-only
                }
                return cellProperties;
            }
        });

        function saveChanges() {
            const form = document.createElement('form');
            form.method = 'POST';
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            // Strip HTML for saving (keep text, or handle as-is if needed)
            const strippedData = hot.getData().map(row => row.map(cell => cell.replace(/<[^>]+>/g, '')));  // Optional: strip tags on save
            input.value = JSON.stringify(strippedData);  // Or use hot.getData() if keeping HTML
            form.appendChild(input);
            const saveInput = document.createElement('input');
            saveInput.type = 'hidden';
            saveInput.name = 'save_data';
            saveInput.value = '1';
            form.appendChild(saveInput);
            document.body.appendChild(form);
            form.submit();
        }
    </script>
</body>
</html>

